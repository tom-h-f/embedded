global:
  scrape_interval: 15s

scrape_configs:
  # Prometheus self-monitoring
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]

  # Static targets for metrics exporters
  - job_name: "node-exporter"
    static_configs:
      - targets: ["node-exporter:9100"]

  - job_name: "cadvisor"
    static_configs:
      - targets: ["cadvisor:8080"]

  # Automated Docker Discovery (excludes cadvisor and node-exporter since they have static configs)
  - job_name: "docker-discovery"
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      - source_labels: [__meta_docker_container_label_prometheus_scrape]
        regex: "true"
        action: keep
      # Exclude cadvisor and node-exporter (handled by static configs)
      - source_labels: [__meta_docker_container_name]
        regex: "/(cadvisor|node-exporter)"
        action: drop
      # Map the container name to the instance label
      - source_labels: [__meta_docker_container_name]
        target_label: instance

  # DNS Service Discovery for Tailscale nodes
  - job_name: "tailscale-nodes"
    dns_sd_configs:
      - names:
          - "_metrics._tcp.meerkat-decibel.ts.net"
        type: "SRV"
        refresh_interval: "30s"
